---
title: HTB - Haze
date: 2025-08-27 19:30:00 +0000
toc: true
categories: [windows, active directory]
tags: [adcs, splunk, cve-2024-36991,netexec,nxc, godap, gmsa, msDS-KeyCredentialLink, SeImpersonatePrivilege]
media_subpath: /assets/img/haze
image: haze.png
description: by exploiting an lfi vulnerability in splunk, we will retrieve paul's encrypted password inside authentication.conf file, after decrypting the password and spraying it, we find that the user mark is using the same password as paul. the user mark has write permission over the msDS-GroupMSAMembership attribute of the haze-it-backup$ account, we will exploit this permission to read haze-it-backup$'s ntlm hash, then we will set up shadow credentials for the user edward by writing a public key to the msDS-KeyCredentialLink attribute. using the shadow credentials we will login to the domain controller and download a splunk backup zip file to our machine where we will find alexander's password. using this passwrod we can access the splunk instance as admin and deploy a revesehell there, finally we will abuse the SeImpersonatePrivilege privilege that alexander has to obtain a reverse shell as system.
---

## Recon - CVE-2024-36991
Scanning the target ip address 10.10.11.61 with nmap , gives us the following results
1. our target host is a windows domain controller dc01.haze.htb
2. LDAP over SSL is enabled (ADCS may be in use)
![Desktop View](DC-usual-ports.png){: width="1004" height="762" }
3. unusual services running on ports 8000, 8088, 8089
![Desktop View](DC-unusual-ports.png){: width="1030" height="710" }
the service running on port 8000 displays the `Splunk` login page.
![Desktop View](splunk-login-page.png){: width="1522" height="817" }
as this is not a custom software, we can start by looking online for default credentials and cves with proof of concept available.
searching in the <a href="https://github.com/projectdiscovery/nuclei-templates/blob/main/cves.json">nuclei-templates</a> github repo, there is a cve that we can check for
![Desktop View](cves.splunk.png){: width="1459" height="769" }
here is the proof of concept
![Desktop View](splunk-LFI-POC.png){: width="1459" height="769" }
let's verify if this splunk instance is vulnerable, yes it is.
![Desktop View](splunk-cve-verification.png){: width="1458" height="183" }
## Paul.Taylor - password decryption
the splunk instance running on the domain controller has an lFI vulnerability, now its time to think of what files we can read from the host.
why not starting with splunk's log and configuration files. looking online, this <a href="https://gist.github.com/luckylittle/fa882d0c2d5fbec3aa8b83618a64389e">gist</a> contains several splunk configuration filenames.
![Desktop View](splunk-gist-config-files.png){: width="1458" height="198" }
one interesing config file is `authentication.conf`, its purpose is to configure authentication settings for users. let's grab this file and 
see what is in there, it is located at the following path `/Program Files/Splunk/etc/system/local/`
![Desktop View](authentication-conf.png){: width="1492" height="793" }
there is an ldap authentication configured using `paul taylor` user and the password looks like it is hashed or encrypted.
<a href="https://github.com/HurricaneLabs/splunksecrets">splunksecrets</a> from HurricaneLabs can be used to decrypt paul's password
![Desktop View](splunksecret-tool.png){: width="1456" height="423" }
the only requirement is the splunk secret key that we can retrieve from `splunk.secret` file
![Desktop View](splunk.secret.png){: width="1491" height="187" }
decrypting paul's password
![Desktop View](splunksecrets-decrypt-paul.png){: width="1438" height="358" }
let's verify this password and see if it is valid, yes it is
![Desktop View](nxc-validate-paul-creds.png){: width="1425" height="190" }
## Paul.Taylor - restricted user
with valid domain user credentials in our hands, we can perfrom an authenticated domain enumeration. i will use the tool <a href="https://github.com/Macmod/godap">godap</a>.
checking all the computers in the domain, there are two computers, `DC01$` and `Haze-It-Backup$`.
![Desktop View](godp-paul-all-computers.png){: width="1421" height="687" }
it seems like the user paul is the only user in the domain, and it is inside an OU called `restricted users`. interesting.
![Desktop View](godp-paul-all-users.png){: width="1421" height="687" }
checking the members of the `remote management users` group, we can see that there two users, `edward` and `mark`,however 
we were not able to retrieve them when we tried to get all users in the domain.
![Desktop View](godp-paul-rmu-group.png){: width="1407" height="687" }
from the above data, it looks like the user paul does not have much to do as it is hinted in the OU name restricted users.
it's time to think of something else.
## Mark.Adams - password spraying
because of the restrictions applied to the user paul, we don't have read permissions over other users and groups. 
however, we discovered two users, mark and edward by looking directly at the members of the remote management users group. 
sparying paul's password for this two users resulted in mark using the same password as paul.
![Desktop View](password-spray.png){: width="1392" height="91" }
## Haze-it-backup$ - read gMSA password.
the user mark uses the same password as paul, if we try to enumerate the domain as mark we can see a lot more data then we did when using paul.
the Haze-it-backup$ is a `gMSA` account, and only `domain admins` can read its password as we can see below.
![Desktop View](who-can-read-gmsa-before.png){: width="1430" height="165" }
checking Haze-it-backup$'s `DACL`, we can see that members of the `gMSA_Managers` group have write permission over the 
attribute `msDS-GroupMSAMembership`, and this attribute specifies who can read gMSA's password
![Desktop View](godap-haze-it-backup-dacl.png){: width="1396" height="692" }
and mark is a member of gMSA_Managers group.
![Desktop View](godap-mark-memberof.png){: width="1396" height="692" }
also, mark is a member of the remote management users group as we can see above.	
now, with the information we collected above, we will access the domain controller using `winrm` to update the 
msDS-GroupMSAMembership attribute of haze-it-backup$ account to allow mark to read its password.
![Desktop View](connecting-with-evil-winrm-to-make-marl-able-to-read-gmsa.png){: width="1430" height="214" }
now let's read haze-it-backup$'s ntlm hash.
![Desktop View](haze-it-backup-password-retrieved.png){: width="1425" height="158" }
haze-it-backup$ account is now compromised, let's see where this account can led us to ?
## Edward.Martin - shadow credentials
previously, when we were enumerating the domain using paul account, we saw that there is a user called edward who is a member
of the remote management users group, however he still did not show up even when we switched to mark to do the domain 
enumeration. as we can see below there is no user edward when we query for all domain users.
![Desktop View](godap-mark-memberof.png){: width="1396" height="692" }
interesting, let's try switching again from mark to haze-it-backup$ account for domain enumeration.	
and here it is, we can see now the user edward after switching to haze-it-backup$	
![Desktop View](godap-edward-martin-user-appears-when-login-as-gmsa-account.png){: width="1429" height="672" }
checking edward's `DACL`, we can see that members of `support_services` group can read and write to the `msDS-KeyCredentialLink` attribute.		
this attribute allows an account to have an alternative authentication method like using `public-private` key for authentication instead of a password.
![Desktop View](godap-edward.martin-dacl-list.png){: width="1429" height="672" }
looking at the support_services group's DACL, the haze-it-backup$ account can change support_services group `owner`. that's good.
![Desktop View](godap-support_services_group-dacl-list.png){: width="1433" height="671" }
so far, this is what we know:
* the account `haze-it-backup$` is able to change the `owner` of the `support_services` group.
* members of the `support_services` group are able to `write` to the `msDS-KeyCredentialLink` attribute for the user `edward`
from the collected information above, here are the steps we will take to compromise `edward`.
1. change the `owner` of the `support_services` group to `haze-it-backup$` account.
2. give `mark` the necessary rights to `add members` in the `support_services` group.
3. switching to `mark` account, `add` `haze-it-backup$` to the `members` of the `support_services` group.
4. switching back to `haze-it-backup$`, we will set up `shadow credentials` by writing a `public key` to the `msDS-KeyCredentialLink` attribute for the user `edward`
![Desktop View](setting-up-the-shadow-credentials-for-edward.png){: width="1592" height="743" }
we successfully obtained a valid `certificate` that we can use to authenticate as edward.
to retrieve edward's `hash`, i will login to the domain controller using mark account and then upload `rubeus` and the `certificate` 
we have generated above, and finally execute rubeus on the domain controller to get the hash.
![Desktop View](getting-edwards-hash-1.png){: width="1592" height="782" }
![Desktop View](getting-edwards-hash-2.png){: width="1592" height="782" }
the user edward has been compromised successfully.
## Alexander.Green - splunk backup
from previous enumeration results, we know that edward is a member of the `backup_reviewers` and `remote management users`
groups, so let's login to the domain controller using winrm as edward and see what we can find there.
the user `flag` is found
![Desktop View](user-flag.png){: width="853" height="210" }			
there is an interesting compressed `splunk backup file`, let's download this backup file and analyze it locally on our machine.
![Desktop View](splunk-backup-file-location.png){: width="1032" height="115" }	
the credentials for `alexander` are found inside this splunk backup	
![Desktop View](alexander-creds-found-in-the-backup.png){: width="1426" height="671" }		
we will `decrypt` the password using the `splunk secret` found in the `backup` just like we did with paul.
![Desktop View](decrypting-alexander-password.png){: width="1425" height="129" }
and the user alexander is compromised successfully.
## System - SeImpersonatePrivilege	
the user alexander is a member of the `splunk_admins` group, this means we can login to splunk as admin, the username to sign in as is `admin`		
![Desktop View](splunk-login-as-admin.png){: width="1448" height="811" }			
by following the instructions on this github <a href="https://github.com/0xjpuff/reverse_shell_splunk">repo</a>. we will install an application that will give us a `reverse shell`		
![Desktop View](splunk-reverse-shell.png){: width="1456" height="381" }				
![Desktop View](uploading-splunk-reverse-shell.png){: width="836" height="447" }			
checking alexander's privileges, there is an `SeImpersonatePrivilege` privilege. this means we can impersonate any user's token.
i will execute <a href="https://github.com/itm4n/PrintSpoofer">printspoofer</a> tool to give me a reverse shell as the `dc01$` user
![Desktop View](printspoofer-LPE.png){: width="1423" height="475" }	
and finally here is the `root` flag
![Desktop View](root-flag.png){: width="666" height="332" }




















